# ================================================================
# n8n Docker Compose Configuration for Windows
# ================================================================
# This file provides a production-ready n8n setup with Docker
# Usage:
#   1. Customize environment variables below
#   2. Run: docker compose up -d
#   3. Access at: http://localhost:5678
# ================================================================

version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n

    # Port mapping: host_port:container_port
    ports:
      - "5678:5678"

    # Environment variables
    environment:
      # Timezone configuration
      - GENERIC_TIMEZONE=America/New_York

      # Basic authentication (REQUIRED for production)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=change_this_password

      # Encryption key (IMPORTANT: Backup this key!)
      # Generate with: openssl rand -base64 32
      - N8N_ENCRYPTION_KEY=your_32_character_encryption_key_here

      # Execution data pruning (prevents database bloat)
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168  # Hours (7 days)

      # Binary data storage mode
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem

      # Optional: Webhook URL for external services
      # - WEBHOOK_URL=https://yourdomain.com/

      # Optional: Enable/disable telemetry
      - N8N_DIAGNOSTICS_ENABLED=false

    # Volume mapping for persistent data
    volumes:
      - n8n_data:/home/node/.n8n

      # Optional: Mount local files directory
      # - ./n8n-files:/files

    # Restart policy
    restart: unless-stopped

    # Resource limits (adjust based on your system)
    # Uncomment to enable:
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

    # Network configuration
    networks:
      - n8n-network

    # Health check (optional)
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ================================================================
# Optional: PostgreSQL Database for Production
# ================================================================
# Uncomment this section for production deployments
# PostgreSQL provides better performance than SQLite

  # postgres:
  #   image: postgres:15-alpine
  #   container_name: n8n-postgres
  #
  #   environment:
  #     - POSTGRES_USER=n8n
  #     - POSTGRES_PASSWORD=change_this_db_password
  #     - POSTGRES_DB=n8n
  #
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #
  #   restart: unless-stopped
  #
  #   networks:
  #     - n8n-network
  #
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U n8n"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

# Then update n8n service environment:
  # - DB_TYPE=postgresdb
  # - DB_POSTGRESDB_HOST=postgres
  # - DB_POSTGRESDB_PORT=5432
  # - DB_POSTGRESDB_DATABASE=n8n
  # - DB_POSTGRESDB_USER=n8n
  # - DB_POSTGRESDB_PASSWORD=change_this_db_password

# ================================================================
# Volumes
# ================================================================
volumes:
  n8n_data:
    name: n8n_data

  # Uncomment if using PostgreSQL:
  # postgres_data:
  #   name: n8n_postgres_data

# ================================================================
# Networks
# ================================================================
networks:
  n8n-network:
    name: n8n-network
    driver: bridge

# ================================================================
# Usage Instructions
# ================================================================
# Start services:     docker compose up -d
# Stop services:      docker compose stop
# View logs:          docker compose logs -f n8n
# Restart services:   docker compose restart
# Remove everything:  docker compose down
# Remove with data:   docker compose down -v
# Update n8n:         docker compose pull && docker compose up -d
# ================================================================
